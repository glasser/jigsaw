<!-- XXX put puzzle tags as CSS classes in body attrs -->

<template name='puzzlePage'>
  {{#if puzzleId}}
    {{#if puzzle}}
      {{#with puzzle}}
         {{> puzzleTitle}}
         <div id='tagsAndMeta'>
           {{> tagList}}
           {{> familiesList }}
           {{> metadataList}}
         </div>
         {{> spreadsheets }}
         {{! XXX related queries }}

         {{> comments }}

         {{! XXX images }}
      {{/with}}
    {{else}}
      <h3>No such puzzle</h3>
    {{/if}}
  {{/if}}
</template>

<template name='puzzleTitle'>
  <h3 class='form-inline'>
    Puzzle:
    {{#show section='titleEditor' useEditButton=true}}
      <input type='text' id='setTitle' class='focus-titleEditor' value='{{title}}'>
    {{else}}
      {{title}}
    {{/show}}
  </h3>
</template>

<template name='tagList'>
  <div id='tagList'>
    <div class='form-inline'>
      Tags:
      {{#show section='tagEditor' useEditButton=true hideIcon='ok'}}
        {{#each sorted tags}}
          <span class='tag'><a href="/search/tag={{this}}">{{this}}</a></span>
          <button class='btn removeTag'><i class='icon-remove'></i></button>
        {{/each}}
        <span class='input-append'>
          <input type='text' id='addTags' class='focus-tagEditor' placeholder='new tags'>
          <button class='btn' id='addTagsButton'><i class='icon-plus'></i></button>
        </span>
      {{else}}
        {{#each sorted tags}}
          <span class='tag'><a href="/search/tag={{this}}">{{this}}</a></span>
        {{/each}}
      {{/show}}
    </div>
  </div>
</template>

<template name='familiesList'>
  <div id='familiesList'>
    <ul>
      {{#each allFamilies}}
        <li>
          <div class='form-inline'>
            {{#show section=_id useEditButton=true}}
              {{name}}:
              <select id='family-{{_id}}' class='setFamily focus-{{_id}}'>
                <option></option>
                {{#each values}}
                  <option {{maybeSelected ../_id}}>{{this}}</option>
                {{/each}}
              </select>
            {{else}}
              {{name}}:
              {{#with familyValue}}
                {{#if this}}
                  <a href="/search/{{../../name}}={{this}}"><strong>{{this}}</strong></a>
                {{/if}}
              {{/with}}
            {{/show}}
          </div>
        </li>
      {{/each}}
    </ul>
  </div>
</template>

<template name='metadataList'>
  <div id='metadataList'>
    <ul>
      {{#each allMetadata}}
        <li>
          <div class='form-inline'>
            {{#show section=_id useEditButton=true}}
              {{name}}:
              <input type='text' id='metadata-{{_id}}'
                     class='setMetadata focus-{{_id}}' value='{{metadataValue}}'>
            {{else}}
              {{name}}:
              {{#if url}}
                <a href='{{metadataValue}}' target='_blank'>{{metadataValue}}</a>
              {{else}}
                <strong>{{metadataValue}}</strong>
              {{/if}}
            {{/show}}
          </div>
        </li>
      {{/each}}
    </ul>
  </div>
</template>

<template name='spreadsheets'>
  <h4>Spreadsheets</h4>
  {{#each spreadsheets}}
    <a href="{{link}}" target="spreadsheet+{{docId}}">Edit Spreadsheet</a>
    <br/>
    {{#isolate}}
      {{autoRefresh}}
      <iframe width='80%' height='250' frameborder='1'
              src="{{link}}&amp;output=html&amp;widget=true"></iframe>
    {{/isolate}}
    <br/>
  {{/each}}
  <span class='input-append'>
    <input type='text' id='addSpreadsheet' placeholder='spreadsheet name'/>
    <button class='btn' id='addSpreadsheetButton'><i class='icon-plus'></i></button>
  </span>
</template>

<template name='comments'>
  <h4>Comments</h4>
  <ul>
    {{#each comments}}
      <li class="comment-priority-{{ priority }}">
        by {{ author }} at {{ huntTime created }} [{{ priority }}]
        {{! XXX edit priority }}
        <pre>{{ text }}</pre>
        {{! XXX urlize text }}
        {{! XXX edit comment }}
      </li>
    {{/each}}
    <li>
      {{#if isNobody}}
        [log in at the top of the page to post a new comment]
      {{else}}
        Post a new comment (as {{currentUser.username}}):
        <div class="form">
          <textarea id="add-comment-text" class="input-block-level" rows="20"></textarea>
          <input id="add-comment-button" type="submit" value="add comment">
        </div>
      {{/if}}
    </li>
  </ul>
</template>
